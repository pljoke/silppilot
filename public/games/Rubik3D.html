<!DOCTYPE html>
<html lang="en">
<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rubik 3D - Silp Pilot</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-functions.js"></script>

    <style>
        /* --- 1. CORE THEME --- */
        :root {
            --primary-color: #722F37;
            --secondary-color: #8B4513;
            --bg-color-light: #FAF7F2;
            --bg-color-dark: #F5F2EA;
            --surface-color: #FFFEF9;
            --text-color: #3a2e2c;
            --text-color-secondary: #8B4513;
            --border-color: #E8DDD4;
            --light-text: #fff;
            --success-color: #28a745;
            --danger-color: #dc3545;
            
            /* Rubik Specific Colors */
            --cube-base: #A56A6D;
            --cube-accent1: #FBC02D;
            --cube-accent2: #1976D2;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        html, body { 
            height: 100%; 
            width: 100%;
            overflow: hidden; 
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg-color-light) 0%, var(--bg-color-dark) 100%);
            color: var(--text-color);
        }

        /* --- LANDSCAPE WARNING --- */
        #landscape-warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--primary-color);
            color: white;
            z-index: 99999;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
        }
        
        #landscape-warning .icon {
            font-size: 60px;
            margin-bottom: 20px;
            animation: rotate-phone 2s infinite ease-in-out;
        }

        @keyframes rotate-phone {
            0%, 10% { transform: rotate(0deg); }
            40%, 60% { transform: rotate(-90deg); }
            90%, 100% { transform: rotate(0deg); }
        }

        /* Show warning ONLY on small mobile landscape (< 600px height usually) */
        @media screen and (orientation: landscape) and (max-height: 500px) {
            #landscape-warning { display: flex; }
            .container, .header { display: none !important; }
        }

        /* --- 2. HEADER --- */
        .header {
            background: rgba(255, 253, 250, 0.95);
            padding: 0 20px;
            box-shadow: 0 2px 10px rgba(139, 69, 19, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1001;
            border-bottom: 2px solid var(--secondary-color);
            height: 60px;
        }

        .header h1 {
            color: var(--primary-color);
            font-size: 1.2rem;
            margin: 0;
        }

        .header-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .header-timer {
            font-family: 'Segoe UI', monospace;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-right: 10px;
            width: 60px;
            text-align: right;
            display: none;
        }
        
        .header-timer.danger {
            color: var(--danger-color);
            animation: pulse 1s infinite;
        }

        @keyframes pulse { 50% { opacity: 0.6; } }

        .hamburger-btn {
            display: none;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--primary-color);
            cursor: pointer;
            margin-right: 10px;
        }

        /* --- 3. CONTAINER --- */
        .container {
            width: 100%;
            height: 100%;
            padding-top: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
        }

        .test-container {
            width: 95%;
            max-width: 1400px;
            background: var(--surface-color);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(139, 69, 19, 0.1);
            border: 1px solid var(--border-color);
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            max-height: 98%;
            overflow-y: auto;
        }
        
        .start-screen-card, .tutorial-screen-card { max-width: 600px; }
        .difficulty-screen-card { max-width: 500px; }
        .results-container { max-width: 800px; }

        .hidden { display: none !important; }

        h1, h2, h3 { color: var(--primary-color); }
        h1 { font-size: 1.8rem; margin-bottom: 0.5rem; }
        p { color: var(--text-color-secondary); margin-bottom: 1rem; }

        /* --- 4. BUTTONS --- */
        .btn {
            font-size: 1rem;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 25px;
            border: none;
            font-weight: bold;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            opacity: 0.9;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn:disabled {
            background-color: #ccc !important;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-primary { background: var(--primary-color); color: var(--light-text); }
        .btn-secondary { background: var(--secondary-color); color: var(--light-text); }
        .btn-success { background: var(--success-color); color: var(--light-text); }
        
        .outline-btn {
            background-color: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }
        .outline-btn:hover { background-color: var(--primary-color); color: white; }

        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
            align-items: center;
        }
        
        .action-buttons .btn { width: 100%; max-width: 280px; }
        
        @media (min-width: 992px) {
            .results-container .action-buttons {
                flex-direction: row; 
                justify-content: center;
                gap: 20px;
            }
            .results-container .action-buttons .btn {
                width: auto; 
                max-width: none;
                padding: 12px 30px;
            }
            .test-container { max-height: none; overflow-y: visible; }
        }

        /* --- 5. GAME LAYOUT --- */
        .game-layout {
            display: flex;
            gap: 20px;
            text-align: left;
            height: 100%;
        }

        .question-sidebar {
            flex: 0 0 240px;
            background: var(--bg-color-dark);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            align-self: flex-start;
        }

        .practice-mode-active .question-sidebar { display: none !important; }
        .practice-mode-active .game-content { width: 100%; }
        .practice-mode-active .hamburger-btn { display: none !important; }

        .game-content {
            flex-grow: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-color-dark);
            padding: 8px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-weight: bold;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .question-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(35px, 1fr));
            gap: 5px;
        }

        .question-nav-btn {
            width: 100%;
            aspect-ratio: 1;
            background-color: var(--bg-color-light);
            color: var(--text-color-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
        }
        .question-nav-btn.answered { background-color: var(--primary-color); color: var(--light-text); }
        .question-nav-btn.current { background-color: var(--secondary-color); color: var(--light-text); transform: scale(1.1); }
        .question-nav-btn.correct { background-color: var(--success-color); color: white; }
        .question-nav-btn.incorrect { background-color: var(--danger-color); color: white; }

        .legend { margin-top: 15px; text-align: left; font-size: 12px; }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
        .legend-color { width: 15px; height: 15px; border-radius: 4px; margin-right: 8px; border: 1px solid #ccc; }

        /* --- 6. RUBIK 3D SPECIFIC --- */
        .question-section {
            text-align: center;
            margin-bottom: 10px;
            padding: 10px;
            background: var(--bg-color-dark);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .example-section {
            margin-top: 10px;
            padding: 10px;
            background: var(--bg-color-light);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .puzzle-area {
            background: transparent;
            border: none;
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .puzzle-equation {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            width: 100%;
            height: 100%;
            transform: scale(1.1);
            transform-origin: center center;
        }
        
        .operator {
            font-size: 2rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 0 5px;
        }

        .cube-container {
            width: 120px;
            height: 120px;
            perspective: 800px;
            cursor: grab;
            position: relative;
            flex-shrink: 0;
            display: inline-block;
        }
        .cube-container:active { cursor: grabbing; }

        .cube-object {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transform: rotateX(-25deg) rotateY(45deg);
            transition: transform 0.05s linear;
        }

        .cubie {
            position: absolute;
            width: 34px;
            height: 34px;
            transform-style: preserve-3d;
            top: 43px;
            left: 43px;
        }

        .cubie-face {
            position: absolute;
            width: 34px;
            height: 34px;
            border: 1px solid rgba(0,0,0,0.3);
            box-shadow: inset 0 0 8px rgba(0,0,0,0.05);
            opacity: 1.0;
        }
        
        .cf-front { transform: rotateY( 0deg) translateZ(17px); }
        .cf-back { transform: rotateY(180deg) translateZ(17px); }
        .cf-right { transform: rotateY( 90deg) translateZ(17px); }
        .cf-left { transform: rotateY(-90deg) translateZ(17px); }
        .cf-top { transform: rotateX( 90deg) translateZ(17px); }
        .cf-bottom { transform: rotateX(-90deg) translateZ(17px); }

        .color-base { background-color: var(--cube-base); }
        .color-accent1 { background-color: var(--cube-accent1); }
        .color-accent2 { background-color: var(--cube-accent2); }

        /* --- 7. CHOICES STYLES --- */
        .choices-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 10px;
            width: 100%;
            align-content: center;
        }

        .choice-button {
            position: relative;
            padding: 5px;
            border: 2px solid var(--border-color);
            background-color: #FAF7F2;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 160px;
        }

        .choice-button.selected {
            border-color: var(--secondary-color);
            background-color: var(--border-color);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .choice-button.correct-answer {
            border-color: var(--success-color) !important;
            background-color: #d4edda !important;
            opacity: 1 !important;
        }
        .choice-button.wrong-answer {
            border-color: var(--danger-color) !important;
            background-color: #f8d7da !important;
            opacity: 1 !important;
        }
        
        .choice-button.locked {
            cursor: default;
            pointer-events: auto !important;
        }
        .choice-button.locked .cube-container { cursor: grab; }
        .choice-button.dimmed { opacity: 0.5; }

        .key-hint {
            position: absolute;
            top: 5px;
            left: 8px;
            font-family: 'Segoe UI', sans-serif;
            font-size: 14px;
            font-weight: bold;
            color: var(--secondary-color);
            opacity: 0.6;
        }

        .status-icon {
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 20px;
            font-weight: bold;
            z-index: 10;
        }

        /* NAVIGATION CONTROLS */
        .navigation-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin-top: 15px;
            min-height: 40px;
            flex-shrink: 0;
        }
        .navigation-controls .btn { min-width: 120px; }
        .navigation-controls.test-mode { justify-content: space-between; }

        /* --- 8. RESULTS SCREEN --- */
        .result-summary {
            text-align: left;
            background: var(--bg-color-dark);
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }
        .result-summary p { font-size: 1.1rem; margin: 8px 0; display: flex; justify-content: space-between; }
        .result-summary p strong { font-size: 1.2rem; color: var(--primary-color); }
        
        .result-comparison { display: flex; gap: 1rem; }
        .result-column {
            flex: 1;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--bg-color-dark);
            text-align: left;
        }
        .result-column h3 {
            font-size: 1rem;
            color: var(--text-color-secondary);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
            margin-bottom: 0.5rem;
            text-align: center;
        }
        .result-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap-x: 1rem;
            gap-y: 0.8rem;
            align-items: center;
            font-size: 0.9rem;
        }
        .result-grid span:nth-child(odd) { font-weight: 600; }
        .result-grid span:nth-child(even) { font-weight: bold; text-align: right; }

        /* --- 9. MODAL & LOADER --- */
        .modal {
            position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--surface-color); padding: 20px; border-radius: 15px;
            width: 90%; max-width: 350px; text-align: center;
        }

        .loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(250, 247, 242, 0.85); display: none;
            justify-content: center; align-items: center; z-index: 9999;
        }
        .loader-spinner {
            border: 8px solid var(--border-color); border-top: 8px solid var(--primary-color);
            border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- 10. RESPONSIVE / DEVICE SPECIFIC STYLES --- */
        
        /* 10.1 MOBILE PHONES (Portrait < 600px) */
        @media (max-width: 599px) {
            .hamburger-btn { display: block; }
            .header h1 { font-size: 1.1rem; }
            
            .question-sidebar {
                position: fixed; top: 60px; left: -280px; width: 260px; height: calc(100% - 60px);
                z-index: 1000; transition: left 0.3s ease; box-shadow: 2px 0 5px rgba(0,0,0,0.2); margin: 0;
            }
            .question-sidebar.active { left: 0; }
            .sidebar-overlay {
                display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 999;
            }
            .sidebar-overlay.active { display: block; }

            .game-layout { flex-direction: column; gap: 5px; }
            
            /* COMPACT FOR MOBILE */
            .puzzle-area { height: 110px; }
            .puzzle-equation { 
                transform: scale(0.55); 
                flex-wrap: nowrap; 
                width: 100%;
                justify-content: center;
                margin-left: 0;
            }
            .operator { font-size: 1.5rem; margin: 0 2px; }
            .example-section .puzzle-equation { transform: scale(0.6); }

            .choices-container { 
                gap: 5px; padding: 0; grid-template-columns: 1fr 1fr;
            }
            .choice-button { height: 90px; }
            .choice-button .cube-container { transform: scale(0.55) !important; }

            .result-comparison { flex-direction: column; gap: 10px; }
            .results-container .action-buttons { flex-direction: column; gap: 8px; }
            .results-container .action-buttons .btn { width: 100%; max-width: none; padding: 8px; font-size: 0.9rem; }
            .tutorial-screen-card div { font-size: 0.9rem; }
            .test-container { padding: 10px 5px; }
        }

        /* 10.2 TABLET PORTRAIT (600px - 1024px) - [FIX 1] Bigger Scale */
        @media screen and (min-width: 600px) and (max-width: 1024px) and (orientation: portrait) {
            .hamburger-btn { display: block; }
            
            .question-sidebar {
                position: fixed; top: 60px; left: -280px; width: 280px; height: calc(100% - 60px);
                z-index: 1000; transition: left 0.3s ease; box-shadow: 2px 0 5px rgba(0,0,0,0.2);
            }
            .question-sidebar.active { left: 0; }
            .sidebar-overlay {
                display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.5); z-index: 999;
            }
            .sidebar-overlay.active { display: block; }

            .game-layout { flex-direction: column; gap: 15px; }
            
            /* LARGER THAN MOBILE */
            .puzzle-area { height: 180px; }
            .puzzle-equation { transform: scale(0.85); flex-wrap: nowrap; }
            
            .choices-container { gap: 15px; grid-template-columns: 1fr 1fr; }
            .choice-button { height: 140px; }
            .choice-button .cube-container { transform: scale(0.8) !important; }
            
            .results-container .action-buttons { flex-direction: row; }
        }
    </style>
</head>
<body data-home-url="index.html">

    <div id="landscape-warning">
        <div class="icon">ðŸ“±</div>
        <h2>Please Rotate Your Device</h2>
        <p>This game is designed for Portrait mode.</p>
    </div>

    <div id="loader-overlay" class="loader-overlay"><div class="loader-spinner"></div></div>
    <div id="sidebarOverlay" class="sidebar-overlay"></div>

    <div id="mainHeader" class="header">
        <div style="display:flex; align-items:center;">
            <button id="hamburgerBtn" class="hamburger-btn">â˜°</button>
            <h1>ðŸ§Š Rubik 3D</h1>
        </div>

        <div class="header-buttons">
            <div id="headerTimer" class="header-timer">00:00</div>
            <button id="backToMenuBtn" class="btn btn-secondary hidden" style="padding: 5px 15px; font-size: 0.8rem;">Back</button>
            <button id="backToResultsBtn" class="btn btn-primary hidden" style="padding: 5px 15px; font-size: 0.8rem;">Back to Results</button>
        </div>
    </div>

    <div class="container">
        <div id="startScreen" class="test-container start-screen-card">
            <h1>Rubik 3D</h1>
            <p>Assemble the pieces to complete the 3x3x3 cube.</p>
            <div class="action-buttons">
                <button id="practiceModeBtn" class="btn btn-secondary">Practice Mode</button>
                <button id="testModeBtn" class="btn btn-primary">Test Mode</button>
                <button id="howToPlayBtn" class="btn outline-btn">How to Play</button>
                <button class="btn outline-btn back-to-system-btn">Back to Main Page</button>
            </div>
        </div>

        <div id="difficultyScreen" class="test-container difficulty-screen-card hidden">
            <h2 id="difficultyTitle">Select Difficulty</h2>
            <div class="action-buttons">
                <button onclick="startGame('easy')" class="btn btn-success">Easy (2 Pieces)</button>
                <button onclick="startGame('normal')" class="btn btn-primary">Normal (Mixed)</button>
                <button onclick="startGame('hard')" class="btn btn-secondary">Hard (3 Pieces)</button>
            </div>
        </div>

        <div id="howToPlayScreen" class="test-container tutorial-screen-card hidden">
            <h2>How to Play</h2>
            <div style="text-align: left; font-size: 0.95rem;">
                <p>1. You will see broken pieces of a 3x3x3 cube.</p>
                <p>2. <strong>Goal:</strong> Find the missing piece that completes the cube.</p>
                <p>3. <strong>Controls:</strong> Drag each piece individually to rotate.</p>
            </div>
            
            <div id="howToPlayExample" class="example-section"></div>

            <div class="action-buttons" style="margin-top: 15px;">
                <button id="backToStartBtn" class="btn btn-primary">Back</button>
            </div>
        </div>

        <div id="gameScreen" class="test-container hidden" style="padding: 10px;">
            <div class="game-layout">
                <div class="question-sidebar">
                    <h3>Questions</h3>
                    <div id="questionGrid" class="question-grid"></div>
                    <div class="legend">
                        <div class="legend-item"><div class="legend-color" style="background:var(--secondary-color)"></div> Current</div>
                        <div class="legend-item"><div class="legend-color" style="background:var(--primary-color)"></div> Answered</div>
                        <div class="legend-item"><div class="legend-color" style="background:var(--bg-color-light)"></div> Not Answered</div>
                    </div>
                </div>

                <div class="game-content">
                    <div class="status-bar">
                        <div id="questionCounter">Q 1/15</div>
                        <div style="font-size: 0.8rem; color: #888;">Drag items to rotate</div>
                    </div>

                    <div class="question-section">
                        <div id="puzzleEquation" class="puzzle-equation"></div>
                    </div>

                    <div id="choicesContainer" class="choices-container"></div>

                    <div id="navigationControls" class="navigation-controls"></div>
                </div>
            </div>
        </div>

        <div id="resultsScreen" class="test-container results-container hidden">
            <h2 id="resultsTitle">Results</h2>
            
            <div id="practiceResults" class="result-summary hidden">
                <p>Score: <strong id="practiceScore">0 / 0</strong></p>
                <p>Accuracy: <strong id="practiceAccuracy">0.00%</strong></p>
                <p>Avg. Time: <strong id="practiceAvgTime">0.0s</strong></p>
            </div>

            <div id="testResults" class="result-comparison hidden">
                <div class="result-column">
                    <h3>Current</h3>
                    <div class="result-grid">
                        <span>Score</span><span id="currentScoreDisplay">N/A</span>
                        
                        <span>Accuracy</span><span id="currentAccuracyDisplay">N/A</span>
                        
                        <span>Avg. Time</span><span id="avgTimeDisplay">N/A</span>
                        <span>Percentile</span><span id="currentPercentileDisplay">N/A</span>
                    </div>
                </div>
                <div class="result-column">
                    <h3>Best</h3>
                    <div class="result-grid">
                        <span>Score</span><span id="bestScoreDisplay">N/A</span>
                        
                        <span>Accuracy</span><span id="bestAccuracyDisplay">N/A</span>
                        <span>Percentile</span><span id="bestPercentileDisplay">N/A</span>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button id="reviewBtn" class="btn btn-secondary hidden" onclick="startReviewMode()">Review Answers</button>
                <button id="retakeBtn" class="btn btn-primary">Back to Menu</button>
                <button class="btn outline-btn back-to-system-btn">Back to Main Page</button>
            </div>
        </div>
    </div>

    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h2>Confirm Submission</h2>
            <p>Are you sure?</p>
            <div class="action-buttons" style="flex-direction:row; justify-content:center;">
                <button id="cancelSubmitBtn" class="btn btn-secondary">Cancel</button>
                <button id="confirmSubmitBtn" class="btn btn-primary">Submit</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const API_BASE = "https://us-central1-silp-pilot-platform.cloudfunctions.net";
            const TIME_LIMIT = 840;

            let gameState = {
                mode: 'test',
                difficulty: 'normal',
                questions: [],
                userAnswers: [],
                correctIndices: [],
                currentIndex: 0,
                timer: null,
                timeLeft: TIME_LIMIT,
                startTime: 0,
                choiceOrientations: {},
                practiceChecked: false
            };

            let currentUserEmail = null;

            if (typeof firebase !== 'undefined') {
                const firebaseConfig = {
                    apiKey: "AIzaSyBAVwsclZj7DhBGSB05ZJ0jtEPIlCi6zGA",
                    authDomain: "silp-pilot-platform.firebaseapp.com",
                    projectId: "silp-pilot-platform"
                };
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                const auth = firebase.auth();
                auth.onAuthStateChanged(user => {
                    if (user) currentUserEmail = user.email || user.providerData[0]?.email;
                    if (!currentUserEmail) currentUserEmail = "kritsada.wongtiwanon@gmail.com";
                });
            } else {
                 currentUserEmail = "kritsada.wongtiwanon@gmail.com";
            }

            // --- UI HELPERS ---
            const screens = {
                start: document.getElementById('startScreen'),
                difficulty: document.getElementById('difficultyScreen'),
                howToPlay: document.getElementById('howToPlayScreen'),
                game: document.getElementById('gameScreen'),
                results: document.getElementById('resultsScreen')
            };
            const loader = document.getElementById('loader-overlay');
            const modal = document.getElementById('confirmModal');
            const hamburger = document.getElementById('hamburgerBtn');
            const sidebar = document.querySelector('.question-sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            function switchScreen(screenName) {
                Object.values(screens).forEach(s => s.classList.add('hidden'));
                screens[screenName].classList.remove('hidden');
                
                const backToMenu = document.getElementById('backToMenuBtn');
                const backToResults = document.getElementById('backToResultsBtn');
                
                backToMenu.classList.add('hidden');
                backToResults.classList.add('hidden');

                if (screenName === 'game') {
                    if (gameState.mode === 'practice') {
                        backToMenu.classList.remove('hidden');
                        document.body.classList.add('practice-mode-active');
                    } else {
                        document.body.classList.remove('practice-mode-active');
                    }
                    if (gameState.mode === 'review') backToResults.classList.remove('hidden');
                } else {
                    document.body.classList.remove('practice-mode-active');
                }
                
                if (screenName !== 'game' || gameState.mode === 'review' || gameState.mode === 'practice') {
                    document.getElementById('headerTimer').style.display = 'none';
                } else if (gameState.mode === 'test') {
                    document.getElementById('headerTimer').style.display = 'block';
                }

                if (screenName === 'howToPlay') {
                    renderHowToPlayExample();
                }
            }

            function toggleSidebar() {
                sidebar.classList.toggle('active');
                sidebarOverlay.classList.toggle('active');
            }
            hamburger.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);

            // --- EVENT LISTENERS ---
            document.getElementById('practiceModeBtn').addEventListener('click', () => {
                gameState.mode = 'practice';
                document.getElementById('difficultyTitle').textContent = "Select Practice Difficulty";
                switchScreen('difficulty');
            });

            document.getElementById('testModeBtn').addEventListener('click', () => {
                gameState.mode = 'test';
                document.getElementById('difficultyTitle').textContent = "Select Test Difficulty";
                switchScreen('difficulty');
            });

            document.getElementById('howToPlayBtn').addEventListener('click', () => switchScreen('howToPlay'));
            document.getElementById('backToStartBtn').addEventListener('click', () => switchScreen('start'));
            document.getElementById('backToMenuBtn').addEventListener('click', () => { clearInterval(gameState.timer); switchScreen('start'); });
            document.getElementById('retakeBtn').addEventListener('click', () => { clearInterval(gameState.timer); switchScreen('start'); });
            document.getElementById('backToResultsBtn').addEventListener('click', () => switchScreen('results'));
            document.querySelectorAll('.back-to-system-btn').forEach(btn => btn.addEventListener('click', () => window.open(document.body.dataset.homeUrl, '_top')));

            document.getElementById('cancelSubmitBtn').addEventListener('click', () => modal.classList.remove('active'));
            document.getElementById('confirmSubmitBtn').addEventListener('click', () => { modal.classList.remove('active'); confirmSubmit(false); });

            window.openSubmitModal = () => modal.classList.add('active');

            function renderHowToPlayExample() {
                const container = document.getElementById('howToPlayExample');
                container.innerHTML = ''; 
                const eq = document.createElement('div');
                eq.className = 'puzzle-equation';
                
                const pieceA = [{pos:{x:1,y:1,z:1}, color:'base'}];
                const pieceB = [{pos:{x:1,y:1,z:1}, color:'accent1'}, {pos:{x:2,y:1,z:1}, color:'accent1'}];
                const pieceC = [
                    {pos:{x:1,y:1,z:1}, color:'base'},
                    {pos:{x:2,y:1,z:1}, color:'accent1'},
                    {pos:{x:3,y:1,z:1}, color:'accent1'}
                ];

                eq.appendChild(createCubeContainer(pieceA, true));
                const plus = document.createElement('div'); plus.className = 'operator'; plus.innerText = '+'; eq.appendChild(plus);
                eq.appendChild(createCubeContainer(pieceB, true));
                const equal = document.createElement('div'); equal.className = 'operator'; equal.innerText = '='; eq.appendChild(equal);
                eq.appendChild(createCubeContainer(pieceC, true));
                container.appendChild(eq);
            }

            window.startGame = async (difficulty) => {
                gameState.difficulty = difficulty;
                loader.style.display = 'flex';

                try {
                    const res = await fetch(`${API_BASE}/getRubik3DQuizData?difficulty=${difficulty}`);
                    const data = await res.json();

                    if (data.success) {
                        gameState.questions = data.data;
                        gameState.userAnswers = new Array(gameState.questions.length).fill(null);
                        gameState.correctIndices = gameState.questions.map(q => q.correctIndex);
                        gameState.currentIndex = 0;
                        gameState.timeLeft = TIME_LIMIT;
                        gameState.choiceOrientations = {}; 
                        gameState.startTime = Date.now();
                        gameState.practiceChecked = false; 

                        renderNavGrid();
                        loadQuestion(0);
                        switchScreen('game');

                        if (gameState.mode === 'test') {
                            startTimer();
                        }
                    } else {
                        alert('Error: ' + data.error);
                        switchScreen('start');
                    }
                } catch (e) {
                    console.error(e);
                    alert('Connection failed.');
                    switchScreen('start');
                } finally {
                    loader.style.display = 'none';
                }
            };

            window.startReviewMode = () => {
                gameState.mode = 'review';
                loadQuestion(0);
                switchScreen('game');
            };

            function loadQuestion(index) {
                if (index < 0 || index >= gameState.questions.length) return;
                gameState.currentIndex = index;
                
                if (gameState.mode === 'practice') {
                     gameState.practiceChecked = false;
                }

                document.getElementById('questionCounter').textContent = `Question ${index + 1} / ${gameState.questions.length}`;
                
                document.querySelectorAll('.question-nav-btn').forEach((btn, i) => {
                    btn.classList.remove('current');
                    if (i === index) btn.classList.add('current');
                });

                const q = gameState.questions[index];
                renderScene(q);
                renderChoices(q);
                updateNavigation();
                
                if (window.innerWidth <= 992) {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                }
            }

            function updateNavigation() {
                const nav = document.getElementById('navigationControls');
                nav.className = `navigation-controls ${gameState.mode === 'test' ? 'test-mode' : ''}`;
                
                if (gameState.mode === 'practice') {
                     const hasSelection = gameState.userAnswers[gameState.currentIndex] !== null;
                     
                     if (!gameState.practiceChecked) {
                         if (hasSelection) {
                             nav.innerHTML = `<button class="btn btn-success" onclick="checkPracticeAnswer()">Check Answer</button>`;
                         } else {
                             nav.innerHTML = `<button class="btn btn-success" disabled>Check Answer</button>`;
                         }
                     } else {
                         if (gameState.currentIndex < gameState.questions.length - 1) {
                             nav.innerHTML = `<button class="btn btn-primary" onclick="changeQuestion(1)">Next &gt;</button>`;
                         } else {
                             nav.innerHTML = `<button class="btn btn-primary" onclick="showPracticeResult()">Finish Practice</button>`;
                         }
                     }
                } else if (gameState.mode === 'review') {
                     nav.innerHTML = `
                         <button class="btn btn-secondary" onclick="changeQuestion(-1)" ${gameState.currentIndex === 0 ? 'disabled' : ''}>&lt; Prev</button>
                         <span style="font-weight:bold; color:var(--primary-color)">Review Mode</span>
                         <button class="btn btn-secondary" onclick="changeQuestion(1)" ${gameState.currentIndex === gameState.questions.length - 1 ? 'disabled' : ''}>Next &gt;</button>
                     `;
                } else {
                    nav.innerHTML = `
                        <div style="flex:1; display:flex; justify-content:flex-start;">
                             <button class="btn btn-secondary" onclick="changeQuestion(-1)" ${gameState.currentIndex === 0 ? 'disabled' : ''}>&lt; Prev</button>
                        </div>
                        <div style="flex:1; display:flex; justify-content:center;">
                             <button class="btn btn-primary" onclick="openSubmitModal()">Submit</button>
                        </div>
                        <div style="flex:1; display:flex; justify-content:flex-end;">
                             <button class="btn btn-secondary" onclick="changeQuestion(1)" ${gameState.currentIndex === gameState.questions.length - 1 ? 'disabled' : ''}>Next &gt;</button>
                        </div>
                    `;
                }
            }
            
            window.changeQuestion = (delta) => {
                loadQuestion(gameState.currentIndex + delta);
            };

            window.checkPracticeAnswer = () => {
                gameState.practiceChecked = true;
                renderChoices(gameState.questions[gameState.currentIndex]);
                updateNavigation();
            };

            function renderNavGrid() {
                const grid = document.getElementById('questionGrid');
                grid.innerHTML = '';
                gameState.questions.forEach((_, i) => {
                    const btn = document.createElement('button');
                    btn.className = 'question-nav-btn';
                    btn.textContent = i + 1;
                    if (gameState.mode === 'review') {
                        if (gameState.userAnswers[i] === gameState.correctIndices[i]) {
                            btn.classList.add('correct');
                        } else {
                            btn.classList.add('incorrect');
                        }
                    }
                    btn.onclick = () => loadQuestion(i);
                    grid.appendChild(btn);
                });
            }

            // --- 3D RENDERING LOGIC (FIXED TOUCH SENSITIVITY) ---
            class Rotatable {
                constructor(element, initX, initY, onUpdate) {
                    this.element = element;
                    this.rotX = initX !== undefined ? initX : -25;
                    this.rotY = initY !== undefined ? initY : 45;
                    this.onUpdate = onUpdate;
                    
                    this.isDragging = false;
                    this.lastX = 0;
                    this.lastY = 0;
                    
                    // [FIX 2] Sensitivity
                    this.sensitivity = 0.8; // Default PC
                    
                    this.init();
                    this.update();
                }

                init() {
                    const el = this.element;
                    el.addEventListener('mousedown', (e) => {
                        this.sensitivity = 0.8; 
                        this.start(e.clientX, e.clientY);
                    });
                    window.addEventListener('mousemove', (e) => this.move(e.clientX, e.clientY));
                    window.addEventListener('mouseup', () => this.end());
                    
                    el.addEventListener('touchstart', (e) => {
                        this.sensitivity = 2.5; // Boost for Touch
                        this.start(e.touches[0].clientX, e.touches[0].clientY);
                    }, {passive: false});
                    window.addEventListener('touchmove', (e) => this.move(e.touches[0].clientX, e.touches[0].clientY), {passive: false});
                    window.addEventListener('touchend', () => this.end());
                }

                start(x, y) {
                    this.isDragging = true;
                    this.lastX = x;
                    this.lastY = y;
                    this.element.style.cursor = 'grabbing';
                }

                move(x, y) {
                    if (!this.isDragging) return;
                    if(event.type === 'touchmove') event.preventDefault();
                    
                    const deltaX = x - this.lastX;
                    const deltaY = y - this.lastY;
                    
                    // Use dynamic sensitivity
                    this.rotY += deltaX * this.sensitivity;
                    this.rotX -= deltaY * this.sensitivity;
                    
                    this.update();
                    this.lastX = x;
                    this.lastY = y;
                    if (this.onUpdate) this.onUpdate(this.rotX, this.rotY);
                }

                end() {
                    this.isDragging = false;
                    this.element.style.cursor = 'grab';
                }

                update() {
                    const obj = this.element.querySelector('.cube-object');
                    if (obj) obj.style.transform = `rotateX(${this.rotX}deg) rotateY(${this.rotY}deg)`;
                }
            }

            function createCubieHTML(cubie, scaleFactor = 1) {
                const el = document.createElement('div');
                el.className = 'cubie';
                const size = 34 * scaleFactor;
                const x = (cubie.pos.x - 1) * size;
                const y = (cubie.pos.y - 1) * size;
                const z = (cubie.pos.z - 1) * size;
                el.style.transform = `translate3d(${x}px, ${y}px, ${z}px)`;
                ['front', 'back', 'left', 'right', 'top', 'bottom'].forEach(face => {
                    const f = document.createElement('div');
                    f.className = `cubie-face cf-${face} color-${cubie.color}`;
                    el.appendChild(f);
                });
                return el;
            }

            function createCubeContainer(cubies, isChoice = false, initX, initY, onUpdate) {
                const container = document.createElement('div');
                container.className = 'cube-container';
                const obj = document.createElement('div');
                obj.className = 'cube-object';
                container.appendChild(obj);
                cubies.forEach(c => { obj.appendChild(createCubieHTML(c)); });
                if (isChoice) { obj.style.transform += " scale(0.95)"; }
                new Rotatable(container, initX, initY, onUpdate);
                return container;
            }

            function renderScene(q) {
                const equation = document.getElementById('puzzleEquation');
                equation.innerHTML = '';
                q.puzzlePieces.forEach((piece, i) => {
                    equation.appendChild(createCubeContainer(piece));
                    if (i < q.puzzlePieces.length - 1) {
                        const op = document.createElement('div'); op.className = 'operator'; op.innerText = '+'; equation.appendChild(op);
                    }
                });
                const plus = document.createElement('div'); plus.className = 'operator'; plus.innerText = '+'; equation.appendChild(plus);
                const qMark = document.createElement('div'); qMark.className = 'operator'; qMark.innerText = '?'; qMark.style.color = 'var(--secondary-color)'; equation.appendChild(qMark);
                const eq = document.createElement('div'); eq.className = 'operator'; eq.innerText = '='; equation.appendChild(eq);
                equation.appendChild(createCubeContainer(q.masterCube));
            }

            function renderChoices(q) {
                const container = document.getElementById('choicesContainer');
                container.innerHTML = '';
                const labels = ['A', 'B', 'C', 'D'];
                const correctIdx = q.correctIndex;
                const userIdx = gameState.userAnswers[gameState.currentIndex];

                if (!gameState.choiceOrientations[gameState.currentIndex]) {
                    gameState.choiceOrientations[gameState.currentIndex] = q.choices.map(() => ({
                        x: Math.floor(Math.random() * 360) - 180,
                        y: Math.floor(Math.random() * 360) - 180
                    }));
                }
                const rotations = gameState.choiceOrientations[gameState.currentIndex];

                q.choices.forEach((choice, i) => {
                    const btn = document.createElement('div');
                    let className = 'choice-button';
                    
                    if (gameState.mode === 'practice') {
                        if (gameState.practiceChecked) {
                             className += ' locked';
                             if (i === correctIdx) {
                                className += ' correct-answer';
                                const icon = document.createElement('div'); icon.className = 'status-icon'; icon.innerHTML = 'âœ“'; icon.style.color = 'var(--success-color)'; btn.appendChild(icon);
                             } else if (i === userIdx && i !== correctIdx) {
                                 className += ' wrong-answer';
                                 const icon = document.createElement('div'); icon.className = 'status-icon'; icon.innerHTML = 'âœ—'; icon.style.color = 'var(--danger-color)'; btn.appendChild(icon);
                             } else {
                                 className += ' dimmed';
                             }
                        } else {
                             if (userIdx === i) className += ' selected';
                        }
                    } 
                    else if (gameState.mode === 'review') {
                        className += ' locked';
                        if (i === correctIdx) {
                            className += ' correct-answer'; 
                            const icon = document.createElement('div'); icon.className = 'status-icon'; icon.innerHTML = 'âœ“'; icon.style.color = 'var(--success-color)'; btn.appendChild(icon);
                        } else if (i === userIdx && i !== correctIdx) {
                            className += ' wrong-answer';
                            const icon = document.createElement('div'); icon.className = 'status-icon'; icon.innerHTML = 'âœ—'; icon.style.color = 'var(--danger-color)'; btn.appendChild(icon);
                        } else {
                            className += ' dimmed';
                        }
                    } else {
                        if (userIdx === i) className += ' selected';
                    }

                    btn.className = className;
                    const hint = document.createElement('span'); hint.className = 'key-hint'; hint.textContent = labels[i]; btn.appendChild(hint);
                    
                    const cube = createCubeContainer(
                        choice, 
                        true, 
                        rotations[i].x, 
                        rotations[i].y,
                        (newX, newY) => {
                            rotations[i].x = newX;
                            rotations[i].y = newY;
                        }
                    );
                    
                    if (gameState.mode !== 'review') {
                         btn.onclick = (e) => { 
                             if (e.target.closest('.cube-container')) return; 
                             selectAnswer(i); 
                         };
                    }
                    
                    btn.appendChild(cube);
                    container.appendChild(btn);
                });
            }

            function selectAnswer(index) {
                if (gameState.mode === 'review') return;
                
                if (gameState.mode === 'practice') {
                    if (gameState.practiceChecked) return;
                    gameState.userAnswers[gameState.currentIndex] = index;
                    renderChoices(gameState.questions[gameState.currentIndex]);
                    updateNavigation(); 
                    return; 
                }

                gameState.userAnswers[gameState.currentIndex] = index;
                const navBtns = document.querySelectorAll('.question-nav-btn');
                if (navBtns[gameState.currentIndex]) { navBtns[gameState.currentIndex].classList.add('answered'); }
                renderChoices(gameState.questions[gameState.currentIndex]);
            }

            function startTimer() {
                const timerEl = document.getElementById('headerTimer');
                timerEl.style.display = 'block';
                if (gameState.timer) clearInterval(gameState.timer);
                gameState.timer = setInterval(() => {
                    gameState.timeLeft--;
                    const m = Math.floor(gameState.timeLeft / 60);
                    const s = gameState.timeLeft % 60;
                    timerEl.textContent = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
                    if (gameState.timeLeft <= 60) timerEl.classList.add('danger');
                    if (gameState.timeLeft <= 0) { clearInterval(gameState.timer); confirmSubmit(true); }
                }, 1000);
            }

            window.showPracticeResult = () => {
                let correct = 0;
                gameState.userAnswers.forEach((ans, i) => {
                     if (ans === gameState.correctIndices[i]) correct++; 
                });
                
                const timeUsedMs = Date.now() - gameState.startTime;
                const avgTimeSec = (timeUsedMs / 1000) / gameState.questions.length;

                const acc = (correct / gameState.questions.length) * 100;
                document.getElementById('practiceScore').innerText = `${correct} / ${gameState.questions.length}`;
                document.getElementById('practiceAccuracy').innerText = `${acc.toFixed(2)}%`;
                document.getElementById('practiceAvgTime').innerText = `${avgTimeSec.toFixed(1)}s`;
                
                document.getElementById('practiceResults').classList.remove('hidden');
                document.getElementById('testResults').classList.add('hidden');
                document.getElementById('resultsTitle').textContent = "Practice Complete!";
                switchScreen('results');
            }

            window.confirmSubmit = async (isTimeUp = false) => {
                if (gameState.timer) clearInterval(gameState.timer);
                loader.style.display = 'flex';

                try {
                    if (!currentUserEmail) currentUserEmail = "kritsada.wongtiwanon@gmail.com";
                    
                    const totalQ = gameState.questions.length || 1; 
                    const correctCount = gameState.userAnswers.reduce((acc, ans, i) => 
                        acc + (ans === gameState.correctIndices[i] ? 1 : 0), 0);
                    const accuracy = (correctCount / totalQ) * 100;
                    const timeUsed = TIME_LIMIT - gameState.timeLeft;
                    const avgTime = timeUsed / totalQ;

                    const payload = {
                        userEmail: currentUserEmail,
                        userAnswers: gameState.userAnswers,
                        correctIndices: gameState.correctIndices,
                        totalQuestions: gameState.questions.length,
                        difficulty: gameState.difficulty,
                        timeUsed: timeUsed
                    };

                    const res = await fetch(`${API_BASE}/saveRubik3DScore`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!res.ok) throw new Error(`Server Error: ${res.status}`);
                    
                    const result = await res.json();
                    if (!result.success) throw new Error(result.error || 'Unknown Error');

                    const safeFixed = (val, digits) => (Number(val) || 0).toFixed(digits);

                    document.getElementById('currentScoreDisplay').textContent = `${correctCount} / ${gameState.questions.length}`;
                    
                    // [FIXED] Updated to reference existing elements
                    if (document.getElementById('currentAccuracyDisplay'))
                        document.getElementById('currentAccuracyDisplay').textContent = `${safeFixed(accuracy, 2)}%`;
                    
                    document.getElementById('avgTimeDisplay').textContent = `${safeFixed(avgTime, 1)}s`;
                    document.getElementById('currentPercentileDisplay').textContent = `${safeFixed(result.percentile, 2)}%`;

                    try {
                        const encodedEmail = encodeURIComponent(currentUserEmail);
                        const bestRes = await fetch(`${API_BASE}/getBestRubik3DScore?email=${encodedEmail}&difficulty=${gameState.difficulty}`);
                        
                        if (bestRes.ok) {
                            const bestData = await bestRes.json();
                            if (bestData.success && bestData.data) {
                                document.getElementById('bestScoreDisplay').textContent = `${bestData.data.bestScore} / ${bestData.data.totalQuestions}`;
                                if (document.getElementById('bestAccuracyDisplay'))
                                    document.getElementById('bestAccuracyDisplay').textContent = `${safeFixed(bestData.data.bestAccuracy, 2)}%`;
                                document.getElementById('bestPercentileDisplay').textContent = `${safeFixed(bestData.data.bestPercentile, 2)}%`;
                            } else {
                                document.getElementById('bestScoreDisplay').textContent = "-";
                                if (document.getElementById('bestAccuracyDisplay'))
                                    document.getElementById('bestAccuracyDisplay').textContent = "-";
                                document.getElementById('bestPercentileDisplay').textContent = "-";
                            }
                        }
                    } catch (bestErr) {
                        console.warn("Failed to fetch best score:", bestErr);
                    }

                    document.getElementById('reviewBtn').classList.remove('hidden');
                    document.getElementById('practiceResults').classList.add('hidden');
                    document.getElementById('testResults').classList.remove('hidden');
                    document.getElementById('resultsTitle').textContent = isTimeUp ? "Time's Up!" : "Quiz Results";
                    switchScreen('results');

                } catch (e) {
                    console.error("Submission Error:", e);
                    alert(`Error submitting score: ${e.message}. Please check your connection.`);
                } finally {
                    loader.style.display = 'none';
                }
            };
        });
    </script>
</body>
</html>